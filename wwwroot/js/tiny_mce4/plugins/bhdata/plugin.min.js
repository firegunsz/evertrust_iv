/**
 * plugin.js
 *
 * Copyright, Moxiecode Systems AB
 * Released under LGPL License.
 *
 * License: http://www.tinymce.com/license
 * Contributing: http://www.tinymce.com/contributing
 */

/*jshint unused:false */
/*global tinymce:true */

/**
 * Example plugin that adds a toolbar button and menu item.
 */
 tinymce.PluginManager.requireLangPack('bhdata');
tinymce.PluginManager.add('bhdata', function(ed, url) {
	//var pb = '<img src="' + url + '/img/exam.jpg" class="mceMhExam " $1 />', cls = 'mceMhExam', sep = ed.getParam('mailhunter_examseparator', '<!-- mailhunterexam -->'), pbRE;
	var pb = '<img src="' + ed.documentBaseURI.toAbsolute('ShowEditImg.aspx') + '?Code=AHHH" class="mceBhdata " $1 />', cls = 'mceBhedit', sep = ed.getParam('billhunter_dataseparator', '<!-- billhunterdata -->'), pbRE;
	pbRE = new RegExp(sep.replace(/[\?\.\*\[\]\(\)\{\}\+\^\$\:]/g, function(a) {return '\\' + a;}), 'g');
	
	// Add a button that opens a window
	ed.addButton('bhdata', {
		image : url + '/img/bhdata.png',
		tooltip: '\u8cc7\u6599\u4f86\u6e90\u5340',
		onclick: function() {
			var userurl = ed.documentBaseURI.toAbsolute('NewDataSrc.aspx?precode=' + ed.getParam('precode', 'XXXXX'));
			// Open window
			ed.windowManager.open({
					title: '\u8cc7\u6599\u4f86\u6e90\u5340',
				  file: userurl,
					width : 820 + parseInt(ed.getLang('bhedit.delta_width', 0)),
					height : 420 + parseInt(ed.getLang('bhedit.delta_height', 0)),
					inline : 1
				}, {
					plugin_url : url, // Plugin absolute URL
					some_custom_arg : 'custom arg' // Custom argument
				});
		}
	});
	
	ed.on('BeforeSetContent', function(o) {
		o.content = o.content.replace(pbRE, pb);
				
				//var regex = new RegExp(/\[start\](((?!\[(?:end|start)\]).)+)\[end\]/ig); 
				
				var a = true;
				while(a){
					var si = o.content.indexOf("<billhunterdataor>");
					var ei = o.content.indexOf("</billhunterdataor>");
					if (ei > si){
						var invalue = o.content.substring(si,ei+19);//找出原 <billhuntereditor>(.+?)<\/billhuntereditor>
						var idwh = o.content.substring(si+18,ei);
						var idindex = invalue.indexOf('id="');
						var idindexend = invalue.indexOf('"',idindex+4);
						var idvalue = "";
						if (idindex !== -1){
								idvalue = invalue.substring(idindex+4,idindexend);
							}
						var newstr = "<img src='" + ed.documentBaseURI.toAbsolute('ShowEditImg.aspx') + "?Code=" + idvalue + "' class='mceBhdata ' " + idwh + " />";
						o.content = o.content.replace(invalue,newstr);
					}else{
						a = false;
					}
				}
		
	});
	
	ed.on('PostProcess', function(o) {
		if (o.get)
					o.content = o.content.replace(/<img[^>]+>/g, function(im) {
						
						if (im.indexOf('class="mceBhdata') !== -1){
							//取得 id width height
							var idindex = im.indexOf('id="');
							var idindexend = im.indexOf('"',idindex+4);
							var widthindex = im.indexOf('width="');
							var widthindexend = im.indexOf('"',widthindex+7);
							var heightindex = im.indexOf('height="');
							var heightindexend = im.indexOf('"',heightindex+8);
							var idvalue = "";
							var widthvalue = "";
							var heightvalue = "";
							if (idindex !== -1){
								idvalue = im.substring(idindex+4,idindexend);
							}
							if (widthindex !== -1){
								widthvalue = im.substring(widthindex+7,widthindexend);
							}
							if (heightindex !== -1){
								heightvalue = im.substring(heightindex+8,heightindexend);
							}
							im = '<billhunterdataor>id="'+idvalue+'" width="'+widthvalue+'" height="'+heightvalue+'"</billhunterdataor>';
						}
						return im;
					});
	});
});