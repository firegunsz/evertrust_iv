/**
 * plugin.js
 *
 * Copyright, Moxiecode Systems AB
 * Released under LGPL License.
 *
 * License: http://www.tinymce.com/license
 * Contributing: http://www.tinymce.com/contributing
 */

/*jshint unused:false */
/*global tinymce:true */

/**
 * Example plugin that adds a toolbar button and menu item.
 */
 tinymce.PluginManager.requireLangPack('mhexam');
tinymce.PluginManager.add('mhexam', function(ed, url) {
	var pb = '<img src="' + url + '/img/exam.jpg" class="mceMhExam " $1 />', cls = 'mceMhExam', sep = ed.getParam('mailhunter_examseparator', '<!-- mailhunterexam -->'), pbRE;
	pbRE = new RegExp(sep.replace(/[\?\.\*\[\]\(\)\{\}\+\^\$\:]/g, function(a) {return '\\' + a;}), 'g');
	
	// Add a button that opens a window
	ed.addButton('mhexam', {
		image : url + '/img/mhexam.png',
		tooltip: 'mhexam.examtitle',
		onclick: function() {
			var userurl = ed.documentBaseURI.toAbsolute('ExamList.aspx');
			// Open window
			ed.windowManager.open({
					title: 'mhexam.examtitle',
				  file: userurl,
					width : 820 + parseInt(ed.getLang('mhuser.delta_width', 0)),
					height : 420 + parseInt(ed.getLang('mhuser.delta_height', 0)),
					inline : 1
				}, {
					plugin_url : url, // Plugin absolute URL
					some_custom_arg : 'custom arg' // Custom argument
				});
		}
	});
	
	ed.on('BeforeSetContent', function(o) {
		o.content = o.content.replace(pbRE, pb);
				
				//var regex = new RegExp(/\[start\](((?!\[(?:end|start)\]).)+)\[end\]/ig); 
				
				var regex = new RegExp(/<mailhunterexam>(.+?)<\/mailhunterexam>/ig);
				o.content = o.content.replace(regex,pb); 
		
	});
	
	ed.on('PostProcess', function(o) {
		if (o.get)
					o.content = o.content.replace(/<img[^>]+>/g, function(im) {
						
						if (im.indexOf('class="mceMhExam') !== -1){
							//¨ú±o id width height
							var idindex = im.indexOf('id="');
							var idindexend = im.indexOf('"',idindex+4);
							var widthindex = im.indexOf('width="');
							var widthindexend = im.indexOf('"',widthindex+7);
							var heightindex = im.indexOf('height="');
							var heightindexend = im.indexOf('"',heightindex+8);
							var idvalue = "";
							var widthvalue = "";
							var heightvalue = "";
							if (idindex !== -1){
								idvalue = im.substring(idindex+4,idindexend);
							}
							if (widthindex !== -1){
								widthvalue = im.substring(widthindex+7,widthindexend);
							}
							if (heightindex !== -1){
								heightvalue = im.substring(heightindex+8,heightindexend);
							}
							im = '<mailhunterexam>id="'+idvalue+'" width="'+widthvalue+'" height="'+heightvalue+'"</mailhunterexam>';
						}
						return im;
					});
	});
});